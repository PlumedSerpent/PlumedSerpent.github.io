---
title: 人群计数论文解读之《Single-Image Crowd Counting via Multi-Column Convolutional Neural Network》
tags: CrowdCounting
article_header:
  type: cover
  image:
    src: /cover/MCNN.png

---

> ## 前言
>本篇博客是笔者人群计数读书笔记的第一篇，介绍的工作来源于上海科技大学在CVPR2016发表的论文 [MCNN](https://zpascal.net/cvpr2016/Zhang_Single-Image_Crowd_Counting_CVPR_2016_paper.pdf)。这是将深度学习应用于人群计数的早期工作之一。
<!--more-->
虽然网络结构比较简单，但是适合作为我们进入人群计数领域的基础工作，在这里推荐一个基于pytorch框架的简洁开源实现[Github](https://github.com/CommissarMa/MCNN-pytorch)，建议对照学习。
注：正文包括笔者对原论文的翻译和自己的理解，请读者注意区分人称。

------

## Abstract
  本文提出了一种在任意人群密度或任意透视关系下准确估计单张图片人群数量的方法。为此，我们提出了一个简单有效的多列卷积神经网络架构来将图片映射为对应的人群密度图。该网络允许输入图片为任意分辨率。通过使用不同尺寸感受野的滤波，每列网络学习到的特征能够适应由于图片分辨率或透视效应导致的人体或头部尺度变化。更进一步地，真值密度图是基于几何自适应核计算的（注：而不是之前工作使用的固定尺寸核），因此无需知道输入图像的透视关系图。由于现有数据集无法足够覆盖我们的方法所考虑到的场景需求，我们收集并标注了一个新的包含1198张图片，330,000个头部标注的的大型数据集。在已有数据集和这个新的困难数据集上我们进行了扩展实验证明了我们方法的有效性。尤其需要指明，我们这个简单的网络超过了全部现有工作。同时，我们证明了我们的模型一旦在一个数据集上训练好，可以轻易地迁移到新的数据集。

## Introduction
在2015年的新年夜，35人在中国上海的一场拥挤踩踏事故中遇难。不幸的是，自那以后，更多的拥堵事故发生在全球各地造成更严重的伤亡。因此从图片中或视频中准确估计拥挤情况变成愈加重要的计算机视觉应用以助于拥堵控制和公众安全。在一些场景下，例如公众集会和运动盛会，参与人数或人群密度对于未来举办规划和场地设计是很重要的信息。好的人群计数的方法还可以延伸到其他领域，例如，从显微图像中查出细胞或细菌数量，野生动物保护区内动物数量估计，或者在交通枢纽或交通拥挤处估计机动车数量。

### Related Work

许多文献已经提出了一些人群计数的算法。早期工作采用检测式框架扫描跨视频连续帧的检测器来估计行人数量，这些检测器是基于集成了外观和运动特征的。还有一些工作（注：这里的引用文章请参考原文引用）使用了类似的基于检测的框架。在这些方法中，研究者通常假设人群是由独立的个体组成的，这些个体可以被一些现有的检测器检测，这些方法的局限之处在于，在一些聚集环境或者特别密集的拥挤环境中，遮挡严重影响了检测器准确性，进而影响最终行人数量估计的准确性。

在视频中的人群计数中，人们提出了对视觉特征的追踪轨迹据类的方法，但是这一类方法不适用于独立的静止图片。

可以说最被广泛使用的方法是基于特征的回归方法。这一类方法的主要步骤是：1）分割前景2）从前景中提取不同特征，例如人群面积，边缘检测，纹理特征。3）利用一个映射函数进行数值的回归，线性函数或者分段线性函数可以取得不错的性能，其他高级的或更有效的回归方法例如岭回归，高斯过程回归或者神经网络也被使用。

一些专门针对静态图像的人群计数方法也被提出。比如一些方法利用不同信息--兴趣点，傅里叶分析，小波分解等特征融合进行预测。还有近期一些基于CNN的方法也出现了。虽然这些方法在已有数据中取得较好结果，但是这些方法都需要训练数据和测试数据的透视关系，实际上在应用场景中却很难获得，因此限制了这些方法的应用价值。

### Contributions of this paper

在本文中，我们旨在从任意静止图像，摄像机视角和人群密度进行准确的人群计数。乍一看，这似乎是一项艰巨的任务，因为我们显然需要克服一系列挑战：
1. 在大多数现有工作中，前景分割是必不可少的。 然而，前景分割本身就是一项具有挑战性的任务，不正确的分割将对最终计数产生不可逆的不利影响。 在我们的任务中，图像的视角可以是任意的。 没有有关场景几何或运动的信息，几乎不可能从人群的背景中准确地分割出人群。 因此，我们必须在不先分割前景的情况下估计人群的数量。
2. 在我们的任务（或数据集）中，人群的密度和分布差异很大，通常每个图像中的大多数人都有严重的遮挡。因此，传统的基于检测的方法不适用于此类图像和情况。
3. 由于图像中人物的比例可能存在很大差异，因此我们需要一起使用不同比例的特征，以便准确估计不同图像的人群数量。
由于我们没有跟踪的视觉特征，并且很难手工提取所有不同比例的特征，因此我们不得不求助于能自动学习有效特征的方法。

为了克服上述挑战，我们提出了一种基于卷积神经网络的新框架，用于在任意静止图像中进行人群计数。具体来讲，我们提出了一种多列卷积神经网络（MCNN）。
我们的MCNN包含三列卷积神经网络，它们的滤波大小不同。 MCNN的输入是图像，输出是人群密度图，其积分为总体人群数。
> 注：值得注意的是，MCNN的网络架构来源于
Jurgen Schmidhuber,也就是LSTM的创造者在2012年发表的论文[MCDNN](http://www.idsia.ch/~juergen/cvpr2012.pdf), ，联想到他在2019年底发表的万字长文，阐述深度学习的各项成就“皆备于我”，参见[「LSTM 之父」亲笔万字长文，只为向世人证明：深度学习不是在母语为英语的地方被发明的](https://zhuanlan.zhihu.com/p/91380529)，看来还真是言之不虚啊哈哈。

本文的贡献总结如下：
1. 我们采用多列架构的原因是很自然的：三列对应于具有不同大小（大，中，小）感受野的滤波，因此每列CNN所学习的特征都适用于因透视效应或不同分辨率而导致的人/头大小的较大变化。
   >请各位读者记住这个结论，但是不要把它作为金科玉律，在后续CSRNET的解读中我们会看到这条结论也许太过“仓促”。 
2. 在我们的MCNN中，我们将全连接层替换为为1×1的卷积层。因此，模型的输入图像可以具有任意大小以避免失真。网络的直接输出是对人群密度的估计，从中可以得出总体计数。
   >这个优点实际上会在代码实现上产生一个问题：采用默认的dataloader,batchsize只能为1,(因为输入图片大小不一)，网络中也无法使用BN层。不过有以下几种解决方法：
   >- 改写dataloader的collect_fn函数，对输入图像加padding，使其大小一致。
   >- 改写dataloader的collect_fn函数，将输入图像crop至batch中最小宽高。
   >- 通过在网络开始阶段添加AdaptivePool操作，使其在后续阶段成为统一尺寸。  
   实际上，在[$C^3$ Framework技术报告](https://zhuanlan.zhihu.com/p/65650998)中提到:
   >> “根据经验，如果是from scratch training，对于这几个数据集建议采用多batch size训练或者采用GCC-SFCN中加padding的方案，对于有预训练参数的模型（AlexNet，VGG，ResNet等），建议采用单一batch size进行训练。”

3. 我们收集了一个新的数据集，用于评估人群计数方法的性能。  
现有的人群计数数据集无法在本工作考虑的各种场景中全面测试算法的性能，因为它们在视角变化（UCSD，WorldExpo'10），人群规模（UCSD），数据集规模（UCSD，UCF CC 50）方面存在局限性或各种场景（UCF CC 50）。
在这项工作中，我们介绍了一个名为Shanghaitech的新的大规模人群数据集，其中包含近1200张图像和约330,000个准确标记的头部。据我们所知，就人数标注数量而言，它是最大的人群计数数据集。
该数据集由两部分组成：A部分和B部分。A部分中的图像是从Internet上随机爬取的，其中大部分图像中人群密度较大。
B部分取自上海大都市的繁忙街道。

## Multi-column CNN for Crowd Counting

### Density map based crowd counting

用卷积神经网络（CNN）估计给定图像中的人数，有两种配置方式。
一个输入图像输出人数（数字形式）。另一种是输出人群的密度图（例如每平方米有多少人），然后通过积分获得人数。
在本文中我们选择第二种：
1. 密度图保留了更多信息。   
   与人群总数相比，密度图给出了给定图像中人群的空间分布，这种分布信息在许多应用中很有用。例如，如果某区域的密度比其他区域的密度高得多，则可能表明那里发生了异常情况。 
2. 在通过CNN学习密度图时，所学习的滤波器更适合于不同大小的头部大小，因此更适合于透视效果显著变化的任意输入。因此，滤波器在语义上更具意义，因此提高了人群计数的准确性。
   
### Density map via geometry adaptive kernels
由于需要对CNN进行训练以从输入图像中估计人群密度图，因此训练数据中给出的密度质量在很大程度上决定了我们方法的性能。
我们首先描述如何将带有标签人头的图像转换为人群密度图。